#!/usr/bin/env ruby

require 'slop'
require 'fakeit'

usage = nil
begin
  opts = Slop.parse do |o|
    o.string '--spec', 'spec file uri (required)', required: true
    o.integer '-p', '--port', 'custom port'
    o.bool '-q', '--quiet', 'mute request and response log'
    o.separator ''
    o.separator 'other options:'
    o.on '-v', '--version' do
      puts Fakeit::VERSION
      exit
    end
    o.on '-h', '--help' do
      puts o
      exit
    end

    usage = o
  end
rescue Slop::Error => e
  puts e.message
  puts usage
  exit
end

server = Rack::Handler::WEBrick

trap(:INT) do
  if server.respond_to?(:shutdown)
    server.shutdown
  else
    exit
  end
end

app = Fakeit.build(opts[:spec])
app.use(Fakeit::Middleware::Logger) unless opts[:quiet]
server.run(app, Port: opts[:port], Host: '0.0.0.0')
